---
  - name: Clone webcam capture docker repository
    git:
      repo: https://github.com/mkieboom/raspberrypi-webcam-capture-docker
      dest: ~/raspberrypi-webcam-capture-docker/

  - name: Build the Docker image
    docker_image:
      path: ~/raspberrypi-webcam-capture-docker/
      name: mkieboom/raspberrypi-webcam-capture-docker

  - name: Launch the webcam capture docker container
    shell: docker run -d --restart=always --name=raspberrypi-webcam-capture-docker --device=/dev/video0:/dev/video0 -v /tmp/webcam:/tmp/webcam -e MAPR_USER=mapr -e MAPR_PASSWORD=mapr -e MAPR_HOST=192.168.1.221 -e MAPR_STREAM=imageclassification-stream -e MAPR_STREAM_TOPIC=webcam-image-events mkieboom/raspberrypi-webcam-capture-docker
    register: command_result
    failed_when: "command_result|failed and 'error gathering device information while adding custom device' in command_result.msg"
    ignore_errors: yes

#  - name: Launch the webcam capture docker container
#    docker_container:
#      image: mkieboom/raspberrypi-webcam-capture-docker
#      name: raspberrypi-webcam-capture-docker
#      restart_policy: always
#      state: present
#      devices:
#        - "/dev/video0:/dev/video0"
#      volumes:
#        - "/tmp/webcam:/tmp/webcam"
